name: Deploy to Mew151.net

on:
  push:
    branches: [main]

  workflow_dispatch:

jobs:
  test:
    uses: meisekimiu/mew151.net/.github/workflows/test.yml@deploy-refactor

  deploy-text:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: âš™ï¸ Install utilities
        run: npm install

      - name: ğŸŒ™ Build text versions of site
        run: npm run generate-text

      - name: ğŸ’ğŸŒŒ Deploy Gemini
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.GMI_HOST }}
          username: ${{ vars.GMI_USER }}
          password: ${{ secrets.GMI_PASSWORD }}
          port: ${{ secrets.GMI_PORT }}
          source: "text/gemini/build"
          target: ${{ secrets.GMI_DIRECTORY }}
          strip_components: 3
          overwrite:

      - name: â›³ğŸŒŒ Deploy Gopher
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.GMI_HOST }}
          username: ${{ vars.GMI_USER }}
          password: ${{ secrets.GMI_PASSWORD }}
          port: ${{ secrets.GMI_PORT }}
          source: "text/gopher/build"
          target: ${{ secrets.GOPHER_DIRECTORY }}
          strip_components: 3
          overwrite:

      - name: ğŸ§¾ğŸŒŒ Deploy HTML to text.mew151.net
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.GMI_HOST }}
          username: ${{ vars.GMI_USER }}
          password: ${{ secrets.GMI_PASSWORD }}
          port: ${{ secrets.GMI_PORT }}
          source: "text/www"
          target: ${{ secrets.TEXT_WWW_DIRECTORY }}
          strip_components: 2
          overwrite:

  deploy-portfolio:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: âš™ï¸ Install utilities
        run: npm install

      - name: ğŸ¹ Build TypeScript / Sass
        run: npm run build

      - name: ğŸ’¼ Prepare Portfolio
        run: npm run portfolio-prepare

      - name: ğŸ±ğŸ“„ğŸ’¼ Run Portfolio Deploy
        uses: bcomnes/deploy-to-neocities@v1.1.4
        with:
          api_token: ${{ secrets.PORTFOLIO_API_KEY }}
          cleanup: false
          dist_dir: src/portfolio

  deploy-main:
    runs-on: ubuntu-latest
    needs: test
    env:
      ABBR: ${{ secrets.ABBR }}
      COMPANY_FULLNAME: ${{ secrets.COMPANY_FULLNAME }}
      SITE_DOMAIN: ${{ secrets.SITE_DOMAIN }}
      EMAIL: ${{ secrets.EMAIL }}
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: âš™ï¸ Install utilities
        run: npm install

      - name: ğŸ¹ Build TypeScript / Sass
        run: npm run build

      - name: ğŸ“° Build feed
        run: npm run rss

      - name: ğŸ¥³ Prepare mew151.net
        run: npm run mew151-prepare

      - name: ğŸ“‚ Sync files
        uses: SamKirkland/FTP-Deploy-Action@4.2.0
        with:
          server: ${{ secrets.ftp_server }}
          username: ${{ secrets.ftp_user }}
          password: ${{ secrets.ftp_password }}
          local-dir: ./src/
          server-dir: ./

      - name: ğŸ± Prepare Neocities Deploy
        run: npm run neocities-prepare

      - name: ğŸ±ğŸ› ï¸ğŸª Deploy to Neocities Mirror
        uses: bcomnes/deploy-to-neocities@v1.1.4
        with:
          api_token: ${{ secrets.NEOCITIES_API_TOKEN }}
          cleanup: false
          dist_dir: src
